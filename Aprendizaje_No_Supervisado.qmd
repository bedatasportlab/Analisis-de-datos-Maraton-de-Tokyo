---
title: "Aprendizaje No Supervisado. La Maratón de Tokyo 2025."
author:
  - "Alba Martínez de la Hermosa"
  - "Alonso González Romero"
  - "Daniel López Paredes"
date: "2025-10-16"
format: 
  html:
    css: style.css
    title-block-banner: true
    embed-resources: true
    self-contained: true
toc: true
toc-depth: 2
number-sections: true
lang: es
keywords: ["maratón", "análisis de datos", "Tokyo"]
abstract: "Por realizar"
execute: 
  warning: false
---

# Importacion de librerías y datos
```{r}
# Importo el df de resultadosTokyo tras el EDA realizado: 
resultadosTokyo2025 <-readRDS("resultadosTokyo2025.rds")

# Importo las librerías necesarias: 
source("librerias.R")
```


# Análisis de Componentes Principales

El **Análisis de Componentes Principales (PCA, por sus siglas en inglés *Principal Component Analysis*)** es una técnica de reducción de dimensionalidad no supervisada que transforma un conjunto de variables correlacionadas en un conjunto más pequeño de variables no correlacionadas llamadas **componentes principales**. 

## PCA sobre ritmos de carrera a través de los parciales

En esta sección se realiza un Análisis de Componentes Principales (PCA) para cada categoría de corredores. Se utilizan los tiempos reales de cada segmento de 5km (calculados como diferencia entre tiempos acumulados consecutivos), normalizados por el tiempo final, para capturar las estrategias de carrera y características de cada grupo.

### Configuración General del PCA

```{r}
# ===== VARIABLES ACUMULADAS ORIGINALES =====
vars_acumulados <- c("parcial_5km", "parcial_10km", "parcial_15km", 
                     "parcial_20km", "parcial_25km", "parcial_30km", 
                     "parcial_35km", "parcial_40km")

# ===== FUNCIÓN PARA CALCULAR PARCIALES REALES =====
calcular_parciales_reales <- function(df_datos) {
  # Crear dataframe con tiempo 0 inicial
  df_procesado <- df_datos %>%
    mutate(
      # Segmento 0-5km
      seg_0_5 = parcial_5km,
      # Segmento 5-10km
      seg_5_10 = parcial_10km - parcial_5km,
      # Segmento 10-15km
      seg_10_15 = parcial_15km - parcial_10km,
      # Segmento 15-20km
      seg_15_20 = parcial_20km - parcial_15km,
      # Segmento 20-25km
      seg_20_25 = parcial_25km - parcial_20km,
      # Segmento 25-30km
      seg_25_30 = parcial_30km - parcial_25km,
      # Segmento 30-35km
      seg_30_35 = parcial_35km - parcial_30km,
      # Segmento 35-40km
      seg_35_40 = parcial_40km - parcial_35km,
      # Segmento 40-42.195km (meta)
      seg_40_meta = tiempo_oficial - parcial_40km
    )
  
  return(df_procesado)
}

# ===== CATEGORÍAS A ANALIZAR =====
categorias <- c("Élite", "Alto nivel", "Muy entrenado/a", "Moderadamente entrenado/a", "Principiante")

# ===== FUNCIÓN PARA REALIZAR PCA =====
realizar_pca <- function(df_datos, categoria_nombre) {
  # Filtrar por categoría
  df_cat <- df_datos %>%
    filter(categoria == categoria_nombre)
  
  # Calcular parciales reales
  df_cat_procesado <- calcular_parciales_reales(df_cat)
  
  # Nombre segmentos (sin el último 40-meta por ahora)
  segmentos <- c("seg_0_5", "seg_5_10", "seg_10_15", "seg_15_20", 
                 "seg_20_25", "seg_25_30", "seg_30_35", "seg_35_40")
  
  # Normalizar segmentos por tiempo final (ratios)
  df_pca_norm <- df_cat_procesado %>%
    mutate(across(all_of(segmentos),
                  ~ .x / tiempo_oficial,
                  .names = "rel_{col}")) %>%
    select(Edad, starts_with("rel_"), Nombre)
  
  # Eliminar posibles NA's
  df_pca_norm <- df_pca_norm[complete.cases(df_pca_norm), ]
  
  # Realizar PCA (sin incluir Nombre en el análisis)
  pca_res <- prcomp(df_pca_norm[, -ncol(df_pca_norm)], center = TRUE, scale. = TRUE)
  
  # Guardar nombres para posterior referencia
  attr(pca_res, "nombres") <- df_pca_norm$Nombre
  
  return(pca_res)
}

# ===== CREAR LISTA CON PCA PARA CADA CATEGORÍA =====
pca_lista <- setNames(
  lapply(categorias, function(cat) realizar_pca(resultadosTokyo2025, cat)),
  categorias
)

cat("✓ PCAs calculados para todas las categorías\n")
cat("✓ Parciales reales calculados como diferencias entre tiempos acumulados\n")
cat("✓ Datos normalizados por tiempo oficial\n")
```

---

## Élite

### Análisis de Componentes Principales

```{r}
pca_elite <- pca_lista[["Élite"]]

# Resumen completo
cat("=== RESUMEN PCA - ÉLITE ===\n")
print(summary(pca_elite))

# Autovalores
autovalores_elite <- pca_elite$sdev^2
cat("\n=== AUTOVALORES ===\n")
print(autovalores_elite)

# Autovectores (loadings)
cat("\n=== AUTOVECTORES (Primeros 4 componentes) ===\n")
print(pca_elite$rotation[, 1:4])

# Varianza acumulada
var_acum_elite <- cumsum(pca_elite$sdev^2) / sum(pca_elite$sdev^2)
cat("\n=== VARIANZA ACUMULADA ===\n")
print(var_acum_elite[1:4])
```

### Gráfica de PCA - Élite

```{r}
# Preparar datos para graficar
scores_elite <- as.data.frame(pca_elite$x[, 1:2])
scores_elite$Nombre <- attr(pca_elite, "nombres")

# Gráfica con nombres
ggplot(scores_elite, aes(x = PC1, y = PC2, label = Nombre)) +
  geom_point(size = 4, color = "#1976D2", alpha = 0.7) +
  geom_text(vjust = -1, size = 2.5, fontface = "bold") +
  labs(
    title = "PCA - Categoría Élite",
    x = paste0("PC1 (", round(pca_elite$sdev[1]^2 / sum(pca_elite$sdev^2) * 100, 2), "%)"),
    y = paste0("PC2 (", round(pca_elite$sdev[2]^2 / sum(pca_elite$sdev^2) * 100, 2), "%)")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

### Interpretación

En esta sección se pueden analizar los autovalores, autovectores y la varianza explicada. Los componentes principales representan las direcciones de máxima varianza en el espacio de estrategias de carrera de los atletas de élite.

---

## Alto Nivel

### Análisis de Componentes Principales

```{r}
pca_alto <- pca_lista[["Alto nivel"]]

cat("=== RESUMEN PCA - ALTO NIVEL ===\n")
print(summary(pca_alto))

cat("\n=== AUTOVALORES ===\n")
print(pca_alto$sdev^2)

cat("\n=== AUTOVECTORES (Primeros 4 componentes) ===\n")
print(pca_alto$rotation[, 1:4])

var_acum_alto <- cumsum(pca_alto$sdev^2) / sum(pca_alto$sdev^2)
cat("\n=== VARIANZA ACUMULADA ===\n")
print(var_acum_alto[1:4])
```

### Gráfica de PCA - Alto Nivel

```{r}
scores_alto <- as.data.frame(pca_alto$x[, 1:2])
scores_alto$Nombre <- attr(pca_alto, "nombres")

ggplot(scores_alto, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, color = "#43A047", alpha = 0.7) +
  labs(
    title = "PCA - Categoría Alto Nivel",
    x = paste0("PC1 (", round(pca_alto$sdev[1]^2 / sum(pca_alto$sdev^2) * 100, 2), "%)"),
    y = paste0("PC2 (", round(pca_alto$sdev[2]^2 / sum(pca_alto$sdev^2) * 100, 2), "%)")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

### Interpretación

Analizar los componentes principales para esta categoría...

---

## Muy Entrenado/a

### Análisis de Componentes Principales

```{r}
pca_muy_ent <- pca_lista[["Muy entrenado/a"]]

cat("=== RESUMEN PCA - MUY ENTRENADO/A ===\n")
print(summary(pca_muy_ent))

cat("\n=== AUTOVALORES ===\n")
print(pca_muy_ent$sdev^2)

cat("\n=== AUTOVECTORES (Primeros 4 componentes) ===\n")
print(pca_muy_ent$rotation[, 1:4])

var_acum_muy_ent <- cumsum(pca_muy_ent$sdev^2) / sum(pca_muy_ent$sdev^2)
cat("\n=== VARIANZA ACUMULADA ===\n")
print(var_acum_muy_ent[1:4])
```

### Gráfica de PCA - Muy Entrenado/a

```{r}
scores_muy_ent <- as.data.frame(pca_muy_ent$x[, 1:2])
scores_muy_ent$Nombre <- attr(pca_muy_ent, "nombres")

ggplot(scores_muy_ent, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, color = "#FB8C00", alpha = 0.7) +
  labs(
    title = "PCA - Categoría Muy Entrenado/a",
    x = paste0("PC1 (", round(pca_muy_ent$sdev[1]^2 / sum(pca_muy_ent$sdev^2) * 100, 2), "%)"),
    y = paste0("PC2 (", round(pca_muy_ent$sdev[2]^2 / sum(pca_muy_ent$sdev^2) * 100, 2), "%)")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

### Interpretación

Analizar los componentes principales para esta categoría...

---

## Moderadamente Entrenado/a

### Análisis de Componentes Principales

```{r}
pca_mod_ent <- pca_lista[["Moderadamente entrenado/a"]]

cat("=== RESUMEN PCA - MODERADAMENTE ENTRENADO/A ===\n")
print(summary(pca_mod_ent))

cat("\n=== AUTOVALORES ===\n")
print(pca_mod_ent$sdev^2)

cat("\n=== AUTOVECTORES (Primeros 4 componentes) ===\n")
print(pca_mod_ent$rotation[, 1:4])

var_acum_mod_ent <- cumsum(pca_mod_ent$sdev^2) / sum(pca_mod_ent$sdev^2)
cat("\n=== VARIANZA ACUMULADA ===\n")
print(var_acum_mod_ent[1:4])
```

### Gráfica de PCA - Moderadamente Entrenado/a

```{r}
scores_mod_ent <- as.data.frame(pca_mod_ent$x[, 1:2])
scores_mod_ent$Nombre <- attr(pca_mod_ent, "nombres")

ggplot(scores_mod_ent, aes(x = PC1, y = PC2)) +
  geom_point(size = 3, color = "#E53935", alpha = 0.7) +
  labs(
    title = "PCA - Categoría Moderadamente Entrenado/a",
    x = paste0("PC1 (", round(pca_mod_ent$sdev[1]^2 / sum(pca_mod_ent$sdev^2) * 100, 2), "%)"),
    y = paste0("PC2 (", round(pca_mod_ent$sdev[2]^2 / sum(pca_mod_ent$sdev^2) * 100, 2), "%)")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

### Interpretación

Analizar los componentes principales para esta categoría...

---

## Principiante

### Análisis de Componentes Principales

```{r}
pca_prin <- pca_lista[["Principiante"]]

cat("=== RESUMEN PCA - PRINCIPIANTE ===\n")
print(summary(pca_prin))

cat("\n=== AUTOVALORES ===\n")
print(pca_prin$sdev^2)

cat("\n=== AUTOVECTORES (Primeros 4 componentes) ===\n")
print(pca_prin$rotation[, 1:4])

var_acum_prin <- cumsum(pca_prin$sdev^2) / sum(pca_prin$sdev^2)
cat("\n=== VARIANZA ACUMULADA ===\n")
print(var_acum_prin[1:4])
```

### Gráfica de PCA - Principiante

```{r}
# Para principiantes, muestrear aleatoriamente para no saturar el gráfico
scores_prin_full <- as.data.frame(pca_prin$x[, 1:2])
scores_prin_full$Nombre <- attr(pca_prin, "nombres")

# Muestreo aleatorio: 500 corredores o todos si hay menos
n_muestra <- min(500, nrow(scores_prin_full))
set.seed(42)
indices_muestra <- sample(1:nrow(scores_prin_full), n_muestra, replace = FALSE)
scores_prin <- scores_prin_full[indices_muestra, ]

ggplot(scores_prin, aes(x = PC1, y = PC2)) +
  geom_point(size = 2.5, color = "#6A1B9A", alpha = 0.6) +
  labs(
    title = paste0("PCA - Categoría Principiante (muestra de ", n_muestra, " corredores)"),
    x = paste0("PC1 (", round(pca_prin$sdev[1]^2 / sum(pca_prin$sdev^2) * 100, 2), "%)"),
    y = paste0("PC2 (", round(pca_prin$sdev[2]^2 / sum(pca_prin$sdev^2) * 100, 2), "%)")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank()
  )
```

### Interpretación

Analizar los componentes principales para esta categoría. Nótese que se ha utilizado una muestra aleatoria de corredores para facilitar la visualización debido al gran número de participantes en esta categoría.




